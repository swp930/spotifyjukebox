<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Jukebox Spotify</title>
</head>

<body>
    <h1>Jukebox</h1>
    <div>Jukebox id:
        <div id="jid"></div>
    </div>
    <button onclick="login()">Login</button>
    <button id="connectToJukeBox" onclick="connectToJukeBox()">Connect to jukebox</button>
    <button onclick="logout()">Logout</button>
    <p>Logged in: </p>
    <p id="loggedin"></p>
    <p>In jukebox: </p>
    <p id="injukebox"></p>
    <p>Search for a song</p>
    <input id="search_song" type="search" oninput="searchChange()"> <button onclick="searchForSong()">Search</button>
    <div id="search_song_results"></div>

    <button onclick="playSong()">Start jukebox</button>
    <button onclick="skipSong()">Skip song</button>
    <p>Remaining time is:</p>
    <div id="remaining_time"></div>
    <p>Current queue is: </p>
    <div id="queue"></div>


    <script>
        var regex_temp = /\?jid=(\S*)/
        var arr = window.location.search.match(regex_temp)
        var song_results = []
        var intervalVar
        var lastCalled

        console.log(arr[1])
        var jidGlobal = arr[1]
        document.getElementById("jid").innerHTML = jidGlobal
        var isOwner = false

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/registerjukebox", true);
        xhr.setRequestHeader("Content-Type", "application/json")
        xhr.onreadystatechange = function() { // Call a function when the state changes.
            if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                console.log("Played ")
            }
        }
        xhr.send(JSON.stringify({
            "jid": jidGlobal
        }));


        checkinWithServer()

        function checkinWithServer() {
            var xhr = new XMLHttpRequest();
            var urlCheckSession = "/checksession?jid=" + arr[1]
            var sidCS = getCookie("sid")
            if (sidCS) {
                urlCheckSession += "&sid=" + sidCS
            }
            xhr.open("GET", urlCheckSession, true);
            xhr.onreadystatechange = function() { // Call a function when the state changes.
                if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                    var response = JSON.parse(xhr.response)
                    console.log("URL check session")
                    console.log(response)
                    document.getElementById("loggedin").innerHTML = response.loggedin
                    document.getElementById("injukebox").innerHTML = response.injukebox
                    console.log("Current queue")
                    console.log(response.queue)
                    constructQueueView(response.queue)
                }
            }
            xhr.send();
        }

        checkinDuration()

        function checkinDuration() {
            var url = "/checkinduration?jid=" + jidGlobal
            console.log(url)
            var xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.onreadystatechange = function() { // Call a function when the state changes.
                if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                    var response = JSON.parse(xhr.response)
                    console.log(response)
                    console.log(response.item.duration_ms)
                    console.log(response.progress_ms)
                    var remaining_time = response.item.duration_ms - response.progress_ms
                    console.log(remaining_time)
                    document.getElementById("remaining_time").innerHTML = Math.round(parseInt(remaining_time) / 1000)
                    clearInterval(intervalVar)
                    lastCalled = (new Date()).getTime()
                    intervalVar = setInterval(function() {
                        decrementTime()
                    }, 1000);
                }
            }
            xhr.send()
        }


        function login() {
            console.log("Logging in")
            var sid = getCookie("sid")
            console.log(sid)
            if (sid == "") {
                sid = guid()
                setCookie("sid", sid, 30)
                var xhr = new XMLHttpRequest();
                var url = "/login?jid=" + arr[1] + "&sid=" + sid
                xhr.open("GET", url, true);
                xhr.onreadystatechange = function() { // Call a function when the state changes.
                    if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                        var response = JSON.parse(xhr.response)
                        console.log(response)
                        var redirectURL = response.url
                        window.location.href = redirectURL
                    }
                }
                xhr.send();
            }
            console.log("sid is: " + sid)
        }

        function logout() {
            setCookie("sid", "", -1)
            const url = 'https://www.spotify.com/logout/'
            const spotifyLogoutWindow = window.open(url, 'Spotify Logout', 'width=700,height=500,top=40,left=40')
            setTimeout(() => spotifyLogoutWindow.close(), 2000)
            checkinWithServer()
        }

        var HOST = location.origin.replace(/^http/, 'ws')
        var connection = new WebSocket(HOST);

        function connectToJukeBox() {
            if (getCookie("sid") == null || getCookie("sid") == "") {
                alert("Please login first")
            } else {
                var connectObj = {
                    "message_type": "register",
                    "jid": arr[1],
                    "sid": getCookie("sid")
                }
                connection.send(JSON.stringify(connectObj))
            }
        }

        function playJukeBox() {
            console.log("Play Jukebox")
            var url = "/playjukebox?jid=" + arr[1] + "&sid=" + getCookie("sid")
            var xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.onreadystatechange = function() { // Call a function when the state changes.
                if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                    var response = JSON.parse(xhr.response)
                    console.log(response)
                }
            }
            xhr.send()
        }

        function playSong() {
            console.log("Play song")
            var url = "/playqueue?jid=" + jidGlobal
            xhr.open("GET", url, true);
            xhr.onreadystatechange = function() { // Call a function when the state changes.
                if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                    var response = JSON.parse(xhr.response)
                    console.log(response)
                }
            }
            xhr.send()
        }

        function skipSong() {
            console.log("Skip song")
            var xhr = new XMLHttpRequest();
            var url = "/skipsong?jid=" + jidGlobal
            xhr.open("GET", url, true);
            xhr.onreadystatechange = function() { // Call a function when the state changes.
                if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                    var response = JSON.parse(xhr.response)
                    console.log(response)
                }
            }
            xhr.send()
        }



        connection.onmessage = function(message) {
            console.log("message is ")
            console.log(message)
            if (message.data) {
                var data = JSON.parse(message.data)
                switch (data.message_type) {
                    case 'register_response':
                        document.getElementById("injukebox").innerHTML = data.injukebox
                        isOwner = data.isowner
                        checkinDuration()
                        break
                    case 'queue_response':
                        console.log('queue_response')
                        console.log(data.queue)
                        constructQueueView(data.queue)
                        break
                    case 'length_response':
                        document.getElementById("remaining_time").innerHTML = Math.round(parseInt(data.song_length) / 1000)
                        clearInterval(intervalVar)
                        lastCalled = (new Date()).getTime()
                        intervalVar = setInterval(function() {
                            decrementTime()
                        }, 1000);
                        break
                    default:
                        console.log(data)
                        break
                }
            }
        }

        var rt = document.getElementById("remaining_time")

        function decrementTime() {
            var time = parseInt(rt.innerHTML)
            var currTime = (new Date()).getTime()
            var diff = Math.round((currTime - lastCalled) / 1000)
            time = time - diff
            lastCalled = currTime
            rt.innerHTML = time
            if (time <= 0) {
                clearInterval(intervalVar)
                if (isOwner) {
                    skipSong()
                }
            }

        }

        function guid() {
            let s4 = () => {
                    return Math.floor((1 + Math.random()) * 0x10000)
                        .toString(16)
                        .substring(1);
                }
                //return id of format 'aaaaaaaa'-'aaaa'-'aaaa'-'aaaa'-'aaaaaaaaaaaa'
            return s4() + s4() + '-' + s4() + '-' + s4();
        }

        function setCookie(key, value, days) {
            var date = new Date();
            date.setTime(date.getTime() + (days * 24 * 3600 * 1000))
            var expiryDate = "expires=" + date.toUTCString();
            document.cookie = key + "=" + value + ";" + expiryDate + ";path=/";
        }

        function getCookie(cookieToRetrieve) {
            var withEquals = cookieToRetrieve + "="
            var cookie = document.cookie
            var indexVal = cookie.indexOf(withEquals)
            if (indexVal == -1)
                return ""
            var indexOfSemi = cookie.indexOf(";", indexVal)
            if (indexOfSemi == -1)
                indexOfSemi = cookie.length
            var res = cookie.substring(indexVal + withEquals.length, indexOfSemi)
            return res
        }

        function searchChange() {
            var container = document.getElementById("search_song_results")
            container.innerHTML = ""
        }

        function searchForSong() {
            var searchVal = document.getElementById("search_song").value
            console.log(searchVal)

            var xhr = new XMLHttpRequest();
            var url = "/searchforsong?query=" + searchVal + "&sid=" + getCookie("sid")
            xhr.open("GET", url, true)
            xhr.onreadystatechange = function() {
                if (this.readyState === XMLHttpRequest.DONE || this.status === 200) {
                    var res = JSON.parse(xhr.response)
                    var songs = []
                    for (var i = 0; i < res.length; i++) {
                        var artists = ""
                        for (var j = 0; j < res[i].artists.length; j++) {
                            artists += res[i].artists[j].name
                            if (j != res[i].artists.length - 1)
                                artists += ", "
                        }
                        var song = {
                            "name": res[i].name,
                            "uri": res[i].uri,
                            "artists": artists,
                            "duration": res[i].duration_ms
                        }
                        songs.push(song)
                    }
                    constructResultsView(songs)
                }
            }
            xhr.send()
        }

        function constructResultsView(songs) {
            var container = document.getElementById("search_song_results")
            container.innerHTML = ""
            for (var i = 0; i < songs.length; i++) {
                var songName = songs[i].name + " - " + songs[i].artists
                var duration = songs[i].duration
                var div = document.createElement("div")
                div.innerHTML = songName
                div.id = i
                div.style = "border: 1px solid black;"
                container.appendChild(div)
                var button = document.createElement("button")
                button.innerHTML = "Add this song"
                button.id = songs[i].uri + "&&" + songName + "&&" + duration
                button.onclick = function(event) {
                    addUriToQueue(event.srcElement.id)
                    container.innerHTML = ""
                }
                div.appendChild(button)
            }
        }

        function constructQueueView(queue) {
            var container = document.getElementById("queue")
            container.innerHTML = ""
            for (var i = 0; i < queue.length; i++) {
                var div = document.createElement("div")
                div.innerHTML = queue[i].songname
                div.id = i
                div.style = "border: 1px solid black;"
                container.appendChild(div)
            }
        }

        function addUriToQueue(songid) {

            var arr = songid.split("&&")
            var uri = arr[0]
            var songName = arr[1]
            var duration = arr[2]
            var url = "/addtoqueue?jid=" + jidGlobal + "&uri=" + uri + "&songname=" + songName + "&duration=" + duration
            var xhr = new XMLHttpRequest()
            xhr.open("GET", url, true);
            xhr.onreadystatechange = function() { // Call a function when the state changes.
                if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                    var response = JSON.parse(xhr.response)
                    console.log(response)
                }
            }
            xhr.send()
        }

        window.onbeforeunload = function() {
            var connectObj = {
                    "message_type": "closing",
                    "jid": arr[1],
                    "sid": getCookie("sid")
                }
                //setCookie("sid", "", -2)
            connection.send(JSON.stringify(connectObj))
        }
    </script>
</body>

</html>